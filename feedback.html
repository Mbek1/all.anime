<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Feedback - All.Anime Quiz</title>
  <style>
    :root { --brand: #ff6f61; --bg: #f7f8fb; --card: #fff; --maxw: 900px; }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: Arial, sans-serif; background: var(--bg); color: #111; }
    .wrap { max-width: var(--maxw); margin: 28px auto; padding: 20px; }
    header { display: flex; align-items: center; gap: 16px; margin-bottom: 18px; justify-content: space-between; }
    .header-left { display: flex; align-items: center; gap: 16px; }
    header h1 { margin: 0; color: var(--brand); font-size: 20px; }
    .card { background: var(--card); border-radius: 12px; padding: 18px; box-shadow: 0 6px 22px rgba(15,23,42,0.06); }
    .nav-buttons { display: flex; gap: 8px; margin-bottom: 18px; }
    .nav-buttons button { background: var(--brand); color: white; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; text-decoration: none; }
    .nav-buttons button a { color: white; text-decoration: none; }
    .form-group { margin-bottom: 18px; }
    label { display: block; font-weight: 700; margin-bottom: 6px; font-size: 14px; }
    input, textarea, select { width: 100%; padding: 10px; border: 1px solid #e6e9ee; border-radius: 8px; font-size: 14px; font-family: Arial, sans-serif; }
    textarea { resize: vertical; min-height: 120px; }
    .submit-btn { background: var(--brand); color: white; border: none; padding: 12px 20px; border-radius: 8px; font-size: 15px; cursor: pointer; font-weight: 700; }
    .submit-btn:hover { opacity: 0.9; }
    .submit-btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .success { color: #2e7d32; background: #e8f5e9; padding: 12px; border-radius: 6px; margin-bottom: 15px; font-size: 13px; }
    .error { color: #d32f2f; background: #ffebee; padding: 12px; border-radius: 6px; margin-bottom: 15px; font-size: 13px; }
    footer { margin-top: 20px; text-align: center; color: #666; font-size: 13px; }
    .info { background: #f5f5f5; padding: 12px; border-radius: 8px; margin-bottom: 18px; font-size: 13px; color: #666; }
  </style>
  <script src="js/auth.js"></script>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="header-left">
        <img src="image/allanime-high-resolution-logo-transparent.png" alt="" aria-hidden style="width:44px;height:44px;border-radius:8px;background:linear-gradient(135deg,#ff6f61,#4a90e2)"/>
        <h1>Feedback & Suggestions</h1>
      </div>
    </header>

    <div class="nav-buttons">
      <button><a href="index.html">‚Üê Back to Quiz</a></button>
    </div>

    <div class="card">
      <div class="info">
        üí° Help us improve All.Anime! Your feedback shapes the future of the app. Every suggestion matters!
      </div>

      <div id="successMsg" class="success" style="display:none"></div>
      <div id="errorMsg" class="error" style="display:none"></div>

      <form id="feedbackForm">
        <div class="form-group">
          <label>Your Name (optional)</label>
          <input type="text" id="name" placeholder="Your name or handle" />
        </div>

        <div class="form-group">
          <label>Email (optional)</label>
          <input type="email" id="email" placeholder="your@email.com" />
        </div>

        <div class="form-group">
          <label>Category *</label>
          <select id="category" required>
            <option value="">Select a category...</option>
            <option value="bug">üêõ Bug Report</option>
            <option value="feature">‚ú® Feature Request</option>
            <option value="improvement">üìà Improvement</option>
            <option value="question">‚ùì Question</option>
            <option value="other">üí¨ Other</option>
          </select>
        </div>

        <div class="form-group">
          <label>Feedback *</label>
          <textarea id="message" placeholder="Tell us what you think..." required></textarea>
        </div>

        <button type="submit" class="submit-btn">Send Feedback</button>
      </form>

      <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #e6e9ee;">
        <p style="font-weight: 700; margin-bottom: 8px;">Recent Feedback</p>
        <div id="feedbackList" style="max-height: 300px; overflow-y: auto;">
          <p style="color: #999; font-size: 13px;">Loading feedback...</p>
        </div>
      </div>
    </div>

    <footer>Made for All.Anime ‚Ä¢ Your feedback helps us grow! üôè</footer>
  </div>

<script>
const SUPABASE_URL = 'https://ijsvnrzlzzqfvcvysbjp.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlqc3ZucnpsenpxZnZjdnlzYmpwIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2MjEwMTE3MywiZXhwIjoyMDc3Njc3MTczfQ.gbug-aZgbX7OV-w0UrycSMXWMY3hJUWYaxqI92RgxYU';

class SupabaseClient {
  constructor(url, key) {
    this.url = url;
    this.key = key;
  }

  async insertFeedback(feedback) {
    try {
      const response = await fetch(`${this.url}/rest/v1/feedback`, {
        method: 'POST',
        headers: {
          'apikey': this.key,
          'Authorization': `Bearer ${this.key}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(feedback)
      });

      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`);
      }

      return await response.json();
    } catch (err) {
      console.error('Error inserting feedback:', err);
      throw err;
    }
  }

  async fetchFeedback(limit = 10) {
    try {
      const response = await fetch(
        `${this.url}/rest/v1/feedback?select=*&order=created_at.desc&limit=${limit}`,
        {
          headers: {
            'apikey': this.key,
            'Authorization': `Bearer ${this.key}`
          }
        }
      );

      if (!response.ok) throw new Error(`HTTP ${response.status}`);
      return await response.json();
    } catch (err) {
      console.error('Error fetching feedback:', err);
      return [];
    }
  }
}

const supabase = new SupabaseClient(SUPABASE_URL, SUPABASE_KEY);
const form = document.getElementById('feedbackForm');
const nameInput = document.getElementById('name');
const emailInput = document.getElementById('email');
const categorySelect = document.getElementById('category');
const messageInput = document.getElementById('message');
const successMsg = document.getElementById('successMsg');
const errorMsg = document.getElementById('errorMsg');
const feedbackList = document.getElementById('feedbackList');

// Get authenticated user if available
const authClient = new SupabaseAuth();
if (authClient.isAuthenticated()) {
  nameInput.value = authClient.getDisplayName();
}

form.addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const submitBtn = form.querySelector('.submit-btn');
  submitBtn.disabled = true;
  submitBtn.textContent = 'Sending...';
  
  try {
    const feedback = {
      name: nameInput.value || 'Anonymous',
      email: emailInput.value || null,
      category: categorySelect.value,
      message: messageInput.value,
      user_id: authClient.isAuthenticated() ? authClient.getUserId() : null,
      created_at: new Date().toISOString()
    };

    await supabase.insertFeedback(feedback);

    // Show success message
    successMsg.textContent = '‚úÖ Thank you! Your feedback has been sent.';
    successMsg.style.display = 'block';
    errorMsg.style.display = 'none';

    // Clear form
    form.reset();

    // Reload feedback list
    setTimeout(() => {
      loadFeedback();
      submitBtn.disabled = false;
      submitBtn.textContent = 'Send Feedback';
    }, 1500);
  } catch (err) {
    console.error('Submit error:', err);
    errorMsg.textContent = '‚ùå Failed to send feedback. Please try again.';
    errorMsg.style.display = 'block';
    successMsg.style.display = 'none';
    submitBtn.disabled = false;
    submitBtn.textContent = 'Send Feedback';
  }
});

async function loadFeedback() {
  const feedbacks = await supabase.fetchFeedback(5);

  if (!feedbacks || feedbacks.length === 0) {
    feedbackList.innerHTML = '<p style="color: #999; font-size: 13px;">No feedback yet. Be the first to share!</p>';
    return;
  }

  feedbackList.innerHTML = feedbacks.map(fb => `
    <div style="padding: 10px; border-bottom: 1px solid #f0f0f0; font-size: 13px;">
      <div style="font-weight: 700; color: var(--brand);">${escapeHtml(fb.name || 'Anonymous')} ‚Ä¢ ${fb.category}</div>
      <div style="color: #666; margin-top: 4px;">${escapeHtml(fb.message)}</div>
      <div style="color: #999; font-size: 11px; margin-top: 4px;">${new Date(fb.created_at).toLocaleDateString()}</div>
    </div>
  `).join('');
}

function escapeHtml(text) {
  const map = {
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#039;'
  };
  return text.replace(/[&<>"']/g, m => map[m]);
}

// Load feedback on page load
window.addEventListener('DOMContentLoaded', loadFeedback);
</script>
</body>
</html>
